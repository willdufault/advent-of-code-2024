"""
PART 2 INCOMPLETE
"""

data = """\
.....#..#................#...###..............................#..#.......................................#........................
..................#...........#.............#.#.#.#......................#.......##.........................................#.##.#
....#.......................................................#.......#.........................#...................................
.#.............#...........#..........................#.....................................................................#.....
....#..#................#..........................#..#..#...#..........#....................................#.#..................
...........................#....#.##......................................................................##...................#..
...........................#.....................................#....##.#..#..#.....#................#...........................
.....#..............#........#........................................###...........#..................................#..........
........#..............#............................................................#..............................#..............
......#..............................#..........................#................................................#................
................#..#......................#.......................................................................................
..#.............................##.....#.......................................................#..................................
#.......................................#...#.............................#...........#.#.........#.............#.................
..............................#................................#...#................................................#.............
..............#...............#.................#........................#...#.....#................#.............................
...................................#...#...........#...............#.........#............#...............##...........#.#........
.........................#..................................................................#.........#...........................
.##.............#................................#.......#.........#..............................................#...............
....#.................#.....#.......................................................#......................#......................
#..................................#................#......#.........................#............................................
.....#..................#................#........................................................................................
......#......#.......#......#.#....................#..................................#...................#...#...............#.#.
.................................................#......#......#.........#..................#.....................................
...........#.....#..................................#...#........#......#...#..................#.##....#.................#.......#
........#..#....................................#...................................................................#.......#.....
...........#..............#.............................................#..............#.#........#..##.................#.......#.
......................................#............................................#...#..........................................
.......#.............#............................#.........#................#.......................................#............
..........................................................................#.............#...............................#.........
......##...............#..........................................................................................#...............
.........#..#................................................#..................................#.......#.....................#...
...#..............................#.#.............#........................#..............#..............................#........
.......................................................................................................#.............#............
.....#.......................#..#..........#.....................................................................................#
..........##..........................#...............................#.......................#...............#.............#..#..
..#....#....................#.............#......#.............................................................#..................
.#....#..........................................................................................#.#......#.....................#.
..........................#.......#......................................................#........................................
.#......#.#......................................................................#........#.........#.........#.#.................
.....................................#........#..........#.............................#..#............#....................#.....
............#.........#.........................................................................................#........##.......
....................#.................#.........................#......................#......................................#...
............#....................................................#..#.........#..........#...................................#....
#.....#...................#.........#.#..................................................................................#........
.............................##.......#........................................#..........#..............#..#.....................
.............#....................................^.##....................................................#.....................#.
........................#.#..#......................#............#...#..........................#.......................#.........
......................#.......................................................................#.#..#......................#.......
..................................................#.......##...................................#..................................
.............................#..........................................#..............#.#.............................#..........
....#.............#..................#.....#..........................#....#..........#.........#........................#.......#
...............#...........................#...............#....................................................................#.
..........................#.............#..........................................................#..............................
...............#...................................#.......................#.............................#...............#........
....#......................##......#.#................................................#................#.............#............
.......#...................#..........................................#.....................................#.....................
.#.....................#..........................................................................................................
........#.#...........#....#...................................#..#.#....#..................#.#...............#......#........#...
#....#............#...#.........#...........#......................#.....................#........................................
........................#.............#.................................................................#.....#...................
...............#....................#................##...#...........#.#..............#..........................................
........................#...........##.......#.....#...........................#..#...................................#...........
.............#........................................................................#.....#.#.#.................##..............
......#......................#.........#..............#...............#................#..................#........#..............
..........#..........................................................................................................#............
..................#...........#................#..#.#..............#.#........#...............................#....#..........##..
...........#..............#...................................................#...................................................
..................................................................#............#............................#.................#...
....#...........#...................#..........................................#..........#...........................#...........
........................................#....................#....#..#........................#.....#.............................
................#........................................................................................................#........
...................#......#.....#..............#..................................#...#.............#........................#....
...................#............................................................#.............#...................................
.......#........................#..........#.............#....#....#.............#.............................#...#..............
...#...............##.............................................................#.................#........................#....
.............................#.................#..................#.#....................#.....................................###
...............#....#.....................................................#..............................................#.......#
....................................#..................................#.......................#..................................
#..#............#................................#....#...............#.........#...........................#.....................
...........................................................................................................#.............#....#..#
...................................#....#.........#..................#......#....................#..........#.....................
...........#.............................................................##.#......#.....#......................#...#.............
..#...................................................................................#.................#.........#...............
.......#..#..#.................................#.....................#..............................................#....#........
..........................#....................................................................................................#..
..#.............#......#..................................#..#.......................#..........#...#...##......#.................
....#...................#....#.........................................................#..................................#.......
.................................#...............#.....................#..#.......................................................
...........#......................................................................................................#...........#...
.............#.................................................................#............#..................#........#.........
.......................#.......#..........................................................#...............................#.....#.
...........................................................................#....#....#............................#...............
....................#............#................................................................................................
.....#.........................................#...................#.....#...#.......#..............#............................#
...#.......................................#.........#............#...................#......................#....#............##.
...##.#...........................................#...#................#..........................................................
.......#..##............#..#............#......................................#...............#...........#.........#......#..#..
...............................................................................#.........##........##.............#...............
......#...............................#.........#............#..............................#.........................#....#......
#...........................#....#..#....................................................#..................#.....................
......#.##.......#...........................#...#........#.................................................................#.....
..........#.................................................#..........................................#....#.#.........#.#.#.....
...#...#.....#......#.......#..#.#.........#...............................................................#..........##.........#
..#...#...#..........................................#............................#..........#..........#.........................
#....#............#......#.............#.#.......##...............#................#.............................#................
...............................#...............................................................#..............#.........#.........
....#..............#..#............................................................#.......#................#...................#.
....#...........................#.............................#.............#....#.........#....#...................#.......#.#...
.......#.......................................#....#........#..............#........#....................#.......................
........#...........................#................................#............................................................
...........#....#........#......................................#...........#.................................#..........#........
........#..........................................................................................#...........................#..
#........................................#.................................................................##...#.....#...........
............#..............#...........#............#................#..#.......................#.#.....#.............##..........
..........#..................#..................................................................................................#.
.....................................#..............##..................................#.............#........#..................
..............................#..................#...............#......#..##....................#................................
..#............#....................................#.......................................................#...#.................
..................###..........................#.......#.................................#........................................
.....#.#..........................................................#...........##...#.....#.................................#......
.............................................#.............................#......................#.............#.......#.....#...
...#......................#............#..................................#........................#....................#.......#.
....##..........#..........#...#.............#............#....#......#....................#...........#..#..........#............
..#......................#............#..#..#.......................#.........#......#...............#............#..#............
..#.............#.#.............................#......#......#.........................#......#.#...............#...............#
...#...........#...............#.....................................#.................#....#....#...................#.#...#......
.......#........#....................#.............................................#..............................................
........#............................#....#....#........#...................#.#...............#...#.....................#.........
.##........#.................#...........#...............................##.#.....................................................
.###...........................#........#..#................................................#...........................#........."""

# Transform data.
mtx = []
for line in data.split("\n"):
    row = []
    for idx, char in enumerate(line):
        if char == "^":
            r_start = len(mtx)
            c_start = idx
            row.append(".")
        else:
            row.append(char)
    mtx.append(row)


# Part 1.
from sys import setrecursionlimit

setrecursionlimit(6000)


def dfs(r: int, c: int, dir_idx: int) -> int:
    if r < 0 or r >= rows or c < 0 or c >= cols:
        return 0

    dr, dc = dirs[dir_idx]
    if mtx[r][c] == "#":
        nxt_dir_idx = (dir_idx + 1) % len(dirs)
        nxt_dr, nxt_dc = dirs[nxt_dir_idx]
        return dfs(r - dr + nxt_dr, c - dc + nxt_dc, nxt_dir_idx)

    new = 0
    if (r, c) not in loop:
        loop.add((r, c))
        new = 1

    return new + dfs(r + dr, c + dc, dir_idx)


rows, cols = len(mtx), len(mtx[0])
dirs = [(-1, 0), (0, 1), (1, 0), (0, -1)]
loop = set()
cnt = dfs(r_start, c_start, 0)
print(cnt)


# Part 2.
def mark(r: int, c: int, dr: int, dc: int, dir_idx: int) -> None:
    if r < 0 or r >= rows or c < 0 or c >= cols:
        return

    if mtx[r][c] == "#":
        return

    if (r, c, dir_idx) in loop:
        return
    loop.add((r, c, dir_idx))

    mark(r + dr, c + dc, dr, dc, dir_idx)


def dfs(r: int, c: int, dir_idx: int) -> int:
    if r < 0 or r >= rows or c < 0 or c >= cols:
        return 0

    dr, dc = dirs[dir_idx]
    nxt_dir_idx = (dir_idx + 1) % len(dirs)
    nxt_dr, nxt_dc = dirs[nxt_dir_idx]
    if mtx[r][c] == "#":
        prv_dir_idx = (dir_idx - 1) % len(dirs)
        prv_dr, prv_dc = dirs[prv_dir_idx]
        mark(r - dr + prv_dr, c - dc + prv_dc, prv_dr, prv_dc, nxt_dir_idx)
        return dfs(r - dr + nxt_dr, c - dc + nxt_dc, nxt_dir_idx)

    if (r, c, dir_idx) not in loop:
        loop.add((r, c, dir_idx))

    obst = 0
    if (r, c, nxt_dir_idx) in loop:
        nr, nc = r + dr, c + dc
        nxt = (
            mtx[r + dr][c + dc]
            if nr >= 0 and nr < rows and nc >= 0 and nc < cols
            else "#"
        )
        if nxt != "#":
            obst = 1

    return obst + dfs(r + dr, c + dc, dir_idx)


rows, cols = len(mtx), len(mtx[0])
dirs = [(-1, 0), (0, 1), (1, 0), (0, -1)]
loop = set()

# Mark behind the starting position since it won't be triggered by an obstacle.
dr, dc = dirs[2]
mark(r_start + dr, c_start + dc, dr, dc, 0)

# ! 444 is too low

cnt = dfs(r_start, c_start, 0)
print(cnt)
